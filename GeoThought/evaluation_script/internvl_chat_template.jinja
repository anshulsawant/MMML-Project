{%- if messages[0]['role'] == 'system' -%}
    {%- set system_message = messages[0]['content'] -%}
    {%- if system_message is string -%}
        {{- '<|im_start|>system\n' + system_message + '<|im_end|>\n' -}}
    {%- else -%}
        {%- set system_str = '' -%}
        {%- for content in system_message -%}
            {%- if content['type'] == 'text' -%}
                {%- set system_str = system_str + content['text'] -%}
            {%- endif -%}
        {%- endfor -%}
        {{- '<|im_start|>system\n' + system_str + '<|im_end|>\n' -}}
    {%- endif -%}
{%- else -%}
    {{- '<|im_start|>system\n你是书生·万象，英文名是InternVL，是由上海人工智能实验室、清华大学及多家合作单位联合开发的多模态大语言模型。<|im_end|>\n' -}}
{%- endif -%}
{%- for message in messages -%}
    {%- if messages[0]['role'] != 'system' or not loop.first -%}
        {{- '<|im_start|>' + message['role'] + '\n' -}}
        {%- if message['content'] is string -%}
            {{- message['content'] -}}
        {%- else -%}
            {%- for content in message['content'] -%}
                {%- if content['type'] == 'image' or content['type'] == 'image_url' -%}
                    {{- '<image>\n' -}}
                {%- elif content['type'] == 'video' -%}
                    {{- '<video>\n' -}}
                {%- elif content['type'] == 'text' -%}
                    {{- content['text'] -}}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
        {{- '<|im_end|>\n' -}}
    {%- endif -%}
{%- endfor -%}
{%- if add_generation_prompt -%}
    {{- '<|im_start|>assistant\n' -}}
{%- endif -%}
